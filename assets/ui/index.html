<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    :root {
      --matrix-green: #00ff41;
      --matrix-dark: #0d0208;
      --matrix-light: #003b00;
      --blood-red: #ff1717;
      --dark-red: #8b0000;
      --glow-red: #ff000d;
      --terminal-green: #39ff14;
      --matrix-bg: rgba(0, 15, 2, 0.85);
      --title-font: 'Press Start 2P', cursive;
      --display-font: 'VT323', monospace;
      --number-font: 'VT323', monospace;
      --text-font: 'VT323', monospace;
    }

    .projectile-counter {
      position: absolute;
      bottom: 40px;
      right: 40px;
      background: linear-gradient(135deg, var(--matrix-dark) 0%, rgba(13, 2, 8, 0.95) 100%);
      padding: 15px 25px;
      border-radius: 16px;
      color: #ffffff;
      font-family: 'Arial', sans-serif;
      display: flex;
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid var(--blood-red);
      transition: all 0.3s ease;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.2),
                  inset 0 0 10px rgba(255, 0, 0, 0.1);
    }

    .projectile-counter::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 16px;
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      z-index: -1;
    }

    .projectile-counter.low {
      background: linear-gradient(135deg, rgba(45, 27, 78, 0.85) 0%, rgba(45, 27, 78, 0.95) 100%);
      border-color: var(--neon-pink);
      box-shadow: 0 0 20px rgba(255, 113, 206, 0.3),
                  inset 0 0 15px rgba(255, 113, 206, 0.2);
    }

    .projectile-counter.shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      transform-origin: center center;
      backface-visibility: hidden;
      perspective: 1000px;
    }

    .projectile-icon {
      width: 28px;
      height: 28px;
      background: radial-gradient(circle at 30% 30%, var(--blood-red), var(--dark-red)) !important;
      border-radius: 50%;
      position: relative;
      display: inline-block;
      box-shadow: 0 0 15px var(--glow-red) !important;
      transition: all 0.3s ease;
    }

    .projectile-icon::after {
      content: '';
      position: absolute;
      top: 15%;
      left: 15%;
      width: 30%;
      height: 30%;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      filter: blur(1px);
    }

    .projectile-counter.low .projectile-icon {
      background: radial-gradient(circle at 30% 30%, var(--neon-pink), #ff0055) !important;
      box-shadow: 0 0 15px var(--neon-pink) !important;
    }

    .projectile-count {
      font-family: var(--number-font);
      font-size: 36px;
      font-weight: bold;
      min-width: 35px;
      text-align: center;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      letter-spacing: 2px;
    }

    .count-change {
      animation: pulse 0.5s ease-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    @keyframes shake {
      0%, 100% { transform: translate3d(0, 0, 0) rotate(0deg); }
      10%, 90% { transform: translate3d(-2px, 1px, 0) rotate(-1deg); }
      20%, 80% { transform: translate3d(3px, -1px, 0) rotate(1deg); }
      30%, 50%, 70% { transform: translate3d(-4px, 2px, 0) rotate(-2deg); }
      40%, 60% { transform: translate3d(4px, -2px, 0) rotate(2deg); }
    }

    .particles {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      overflow: hidden;
      z-index: -1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--blood-red);
      border-radius: 50%;
      pointer-events: none;
      box-shadow: 0 0 5px var(--glow-red);
    }

    .scoreboard {
      position: fixed;
      top: 100px;
      left: 40px;
      background: linear-gradient(135deg, var(--matrix-dark) 0%, rgba(13, 2, 8, 0.95) 100%);
      padding: 20px;
      border-radius: 10px;
      color: #ffffff;
      font-family: var(--text-font);
      backdrop-filter: blur(10px);
      border: 1px solid var(--blood-red);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.2),
                  inset 0 0 10px rgba(255, 0, 0, 0.1);
      min-width: 240px;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }

    .leaderboard {
      position: fixed;
      top: 100px;
      right: 40px;
      background: linear-gradient(135deg, var(--matrix-dark) 0%, rgba(13, 2, 8, 0.95) 100%);
      padding: 20px;
      border-radius: 10px;
      color: #ffffff;
      font-family: var(--text-font);
      backdrop-filter: blur(10px);
      border: 1px solid var(--blood-red);
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.2),
                  inset 0 0 10px rgba(255, 0, 0, 0.1);
      min-width: 240px;
      z-index: 100;
    }

    .leaderboard-title {
      font-family: var(--title-font);
      font-size: 18px;
      color: var(--blood-red);
      margin-bottom: 15px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 0 10px var(--glow-red),
                   0 0 20px var(--glow-red);
      transform: none;
    }

    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, rgba(139, 0, 0, 0.1) 0%, rgba(0, 0, 0, 0) 100%);
      margin: 8px 0;
      padding: 10px 15px;
      border-radius: 5px;
      border: 1px solid rgba(255, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .leaderboard-entry:hover {
      transform: translateX(-5px);
      border-color: var(--blood-red);
    }

    .leaderboard-entry.winner {
      background: linear-gradient(90deg, rgba(255, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0) 100%);
      border-color: var(--blood-red);
      color: var(--blood-red);
      text-shadow: 0 0 5px var(--glow-red);
    }

    .player-name {
      font-family: var(--text-font);
      font-size: 14px;
      letter-spacing: 1px;
    }

    .player-rank {
      font-family: var(--number-font);
      font-size: 20px;
      opacity: 0.8;
      min-width: 30px;
      text-align: center;
    }

    .player-wins {
      font-family: var(--number-font);
      font-size: 24px;
      color: var(--matrix-green);
      text-shadow: 0 0 5px var(--terminal-green);
      letter-spacing: 1px;
    }

    .round-info {
      border-bottom: 1px solid var(--blood-red);
      padding-bottom: 15px;
      margin-bottom: 15px;
    }

    .waiting-message {
      font-family: var(--display-font);
      font-size: 16px;
      color: var(--blood-red);
      text-align: center;
      margin: 10px 0;
      animation: pulse 2s infinite;
    }

    .player-count {
      font-size: 18px;
      color: #ffffff;
      text-align: left;
    }

    .round-number {
      font-family: var(--display-font);
      font-size: 16px;
      color: var(--blood-red);
      text-shadow: 0 0 10px var(--glow-red);
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .round-timer {
      position: fixed;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      font-family: var(--display-font);
      font-size: 32px;
      color: var(--matrix-green);
      text-shadow: 0 0 10px var(--terminal-green);
      background: rgba(13, 2, 8, 0.9);
      padding: 15px 30px;
      border-radius: 8px;
      border: 1px solid var(--matrix-green);
      z-index: 100;
      text-align: center;
      min-width: 200px;
    }

    .round-timer.warning {
      color: var(--blood-red);
      text-shadow: 0 0 10px var(--glow-red);
    }

    .round-timer.danger {
      color: var(--blood-red);
      text-shadow: 0 0 15px var(--glow-red);
      animation: matrix-flicker 0.5s infinite;
    }

    @keyframes matrix-pulse {
      0% { opacity: 0.8; text-shadow: 0 0 5px var(--glow-red); }
      50% { opacity: 1; text-shadow: 0 0 20px var(--glow-red); }
      100% { opacity: 0.8; text-shadow: 0 0 5px var(--glow-red); }
    }

    @keyframes matrix-flicker {
      0% { opacity: 0.8; text-shadow: 0 0 10px var(--glow-red); }
      25% { opacity: 0.3; }
      50% { opacity: 1; text-shadow: 0 0 30px var(--glow-red); }
      75% { opacity: 0.5; }
      100% { opacity: 0.8; text-shadow: 0 0 10px var(--glow-red); }
    }

    .score-target {
      font-size: 14px;
      color: #4CAF50;
    }

    .scores-wrapper {
      display: flex;
      gap: 20px;
    }

    .player-score {
      font-family: var(--text-font);
      background: linear-gradient(90deg, rgba(255, 0, 0, 0.1) 0%, transparent 100%);
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid rgba(255, 0, 0, 0.2);
      margin: 5px 0;
    }

    .player-label {
      color: var(--blood-red);
      text-shadow: 0 0 5px var(--glow-red);
    }

    .score-value {
      font-family: var(--number-font);
      font-size: 32px;
      color: var(--matrix-green);
      text-shadow: 0 0 8px var(--terminal-green);
      letter-spacing: 2px;
    }

    .countdown-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(13, 2, 8, 0.95) 0%, rgba(13, 2, 8, 0.98) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .countdown-overlay.visible {
      opacity: 1;
    }

    .countdown-number {
      font-family: var(--display-font);
      font-size: 96px;
      color: var(--blood-red);
      text-shadow: 0 0 30px var(--glow-red);
      animation: countdown-pulse 0.5s ease-out;
      letter-spacing: 4px;
    }

    .countdown-go {
      font-family: var(--display-font);
      font-size: 120px;
      color: var(--matrix-green);
      text-shadow: 0 0 40px var(--terminal-green);
      animation: countdown-zoom 0.5s ease-out;
      transform: none;
    }

    @keyframes countdown-pulse {
      0% { transform: scale(1.5); opacity: 0; }
      50% { transform: scale(0.9); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes countdown-zoom {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .crosshair {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: var(--crosshair-size, 24px);
      height: var(--crosshair-size, 24px);
      pointer-events: none;
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Outer circle */
    .crosshair::before {
      content: '';
      position: absolute;
      width: var(--ring-size, 20px);
      height: var(--ring-size, 20px);
      border: 2px solid var(--crosshair-color, rgba(255, 255, 0, 0.8));
      border-radius: 50%;
      box-shadow: 0 0 4px var(--crosshair-glow, #ffff00),
                  inset 0 0 4px var(--crosshair-glow, #ffff00),
                  0 0 0 1px rgba(0, 0, 0, 0.5);
      display: var(--show-ring, block);
    }

    /* Center dot */
    .crosshair::after {
      content: '';
      position: absolute;
      width: var(--dot-size, 4px);
      height: var(--dot-size, 4px);
      background-color: var(--crosshair-color, rgba(255, 255, 0, 0.9));
      border-radius: 50%;
      box-shadow: 0 0 4px var(--crosshair-glow, #ffff00),
                  0 0 2px rgba(0, 0, 0, 0.8);
      display: var(--show-dot, block);
    }

    /* Scene UI Container and Notifications */
    .scene-ui-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }

    .hit-notification {
      position: absolute;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 1001;
    }

    .hit-notification .score {
      color: var(--matrix-green);
      font-family: var(--display-font);
      font-size: 28px;
      text-shadow: 0 0 10px var(--terminal-green),
                   0 0 20px var(--terminal-green),
                   0 0 30px var(--terminal-green);
      animation: hitNotification 1s cubic-bezier(0.22, 1, 0.36, 1) forwards;
      opacity: 0;
      transform: scale(0.5) translateZ(0);
      transform-origin: center center;
    }

    .block-destroyed-notification {
      position: absolute;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
      z-index: 1001;
    }

    .block-destroyed-notification .score {
      font-family: var(--display-font);
      font-size: 48px;
      font-weight: bold;
      opacity: 0;
      transform: scale(0.5) translateZ(0);
      transform-origin: center center;
      perspective: 1000px;
      --pop-intensity: calc(var(--score-value, 0) * 0.01);
      --glow-intensity: calc(var(--intensity, 0.5) * 100%);
    }

    @keyframes scoreAnimation {
      0% {
        opacity: 0;
        transform: scale(0.5) translateZ(-300px) translateY(calc(50px * var(--pop-intensity))) rotate3d(1, 0, 0, -45deg);
        filter: brightness(calc(100% + var(--glow-intensity)));
      }
      15% {
        opacity: 1;
        transform: scale(1.8) translateZ(200px) translateY(calc(-100px * var(--pop-intensity))) rotate3d(1, 0, 0, 30deg);
        filter: brightness(calc(150% + var(--glow-intensity)));
      }
      30% {
        opacity: 1;
        transform: scale(2) translateZ(150px) translateY(calc(-150px * var(--pop-intensity))) rotate3d(1, 0, 0, 15deg);
        filter: brightness(calc(200% + var(--glow-intensity)));
      }
      50% {
        opacity: 1;
        transform: scale(1.8) translateZ(100px) translateY(calc(-200px * var(--pop-intensity))) rotate3d(1, 0, 0, 0deg);
        filter: brightness(calc(150% + var(--glow-intensity)));
      }
      70% {
        opacity: 0.9;
        transform: scale(1.5) translateZ(50px) translateY(calc(-250px * var(--pop-intensity))) rotate3d(1, 0, 0, -10deg);
        filter: brightness(calc(125% + var(--glow-intensity)));
      }
      85% {
        opacity: 0.7;
        transform: scale(1.2) translateZ(25px) translateY(calc(-300px * var(--pop-intensity))) rotate3d(1, 0, 0, -20deg);
        filter: brightness(calc(110% + var(--glow-intensity)));
      }
      100% {
        opacity: 0;
        transform: scale(1) translateZ(0) translateY(calc(-350px * var(--pop-intensity))) rotate3d(1, 0, 0, -30deg);
        filter: brightness(100%);
      }
    }

    /* Settings Menu */
    .settings-menu {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: linear-gradient(135deg, var(--matrix-dark) 0%, rgba(13, 2, 8, 0.98) 100%);
      padding: 60px;
      border-radius: 20px;
      color: #ffffff;
      font-family: var(--text-font);
      backdrop-filter: blur(10px);
      border: 3px solid var(--blood-red);
      box-shadow: 0 0 40px rgba(255, 0, 0, 0.2),
                  inset 0 0 20px rgba(255, 0, 0, 0.1);
      z-index: 2000;
      min-width: 700px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .settings-menu.visible {
      opacity: 1;
      visibility: visible;
    }

    .settings-title {
      font-family: var(--title-font);
      font-size: 48px;
      color: var(--blood-red);
      text-align: center;
      margin-bottom: 50px;
      text-shadow: 0 0 10px var(--glow-red);
      letter-spacing: 4px;
    }

    .settings-section {
      margin-bottom: 40px;
      padding: 30px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      border: 1px solid rgba(255, 0, 0, 0.2);
    }

    .settings-section-title {
      font-family: var(--title-font);
      font-size: 48px;
      color: var(--blood-red);
      margin-bottom: 40px;
      text-shadow: 0 0 8px rgba(255, 0, 0, 0.4);
      letter-spacing: 3px;
      text-transform: uppercase;
      border-bottom: 2px solid rgba(255, 0, 0, 0.3);
      padding-bottom: 20px;
    }

    .settings-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30px 0;
      border-bottom: 2px solid rgba(255, 0, 0, 0.2);
    }

    .settings-option:last-child {
      border-bottom: none;
    }

    .settings-label {
      font-size: 32px;
      color: #ffffff;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      letter-spacing: 2px;
    }

    .settings-value {
      display: flex;
      align-items: center;
      gap: 30px;
    }

    .settings-button {
      background: linear-gradient(135deg, var(--blood-red) 0%, var(--dark-red) 100%);
      border: none;
      padding: 20px 40px;
      border-radius: 12px;
      color: white;
      font-family: var(--text-font);
      font-size: 32px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.2);
      margin-top: 30px;
      letter-spacing: 2px;
    }

    .settings-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
    }

    .settings-button:active {
      transform: translateY(0);
    }

    /* Settings overlay background */
    .settings-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(3px);
      z-index: 1999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .settings-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .color-dropdown {
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid var(--blood-red);
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      font-family: var(--text-font);
      font-size: 28px;
      cursor: pointer;
      margin-right: 20px;
      min-width: 200px;
      letter-spacing: 1px;
    }

    .color-dropdown option {
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px;
      font-size: 28px;
    }

    .color-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="range"] {
      width: 300px;
      height: 12px;
    }

    input[type="color"] {
      width: 70px;
      height: 70px;
      padding: 0;
      border: none;
      border-radius: 8px;
    }

    #sensitivity-value {
      font-size: 32px;
      min-width: 60px;
      text-align: center;
      letter-spacing: 2px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 28px;
      color: white;
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    #global-size-value,
    #ring-size-value,
    #dot-size-value {
      font-size: 32px;
      min-width: 80px;
      text-align: center;
      letter-spacing: 2px;
    }

    /* Updated HUD Guide Styles */
    .scoring-guide-hud {
      position: fixed;
      left: 40px;
      top: 300px; /* Moved down further */
      background: linear-gradient(135deg, var(--matrix-dark) 0%, rgba(13, 2, 8, 0.85) 100%);
      padding: 15px;
      border-radius: 10px;
      color: #ffffff;
      font-family: var(--text-font);
      border: 1px solid var(--blood-red);
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.15);
      max-width: 320px; /* Increased width */
      opacity: 0.85;
      transition: opacity 0.3s;
    }

    .scoring-guide-hud .guide-header {
      font-family: var(--title-font);
      font-size: 16px; /* Bigger header */
      color: var(--blood-red);
      margin-bottom: 10px;
      letter-spacing: 1.5px;
      text-align: center;
    }

    .scoring-guide-hud .guide-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px; /* Bigger text */
      letter-spacing: 0.5px;
      padding: 4px 0;
    }

    .scoring-guide-hud .guide-icon {
      font-size: 18px; /* Bigger icons */
      min-width: 25px;
      text-align: center;
    }

    /* Countdown Guide Styles (made even bigger) */
    .round-scoring-guide {
      position: fixed;
      left: 50%;
      top: 60%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--matrix-dark) 0%, rgba(13, 2, 8, 0.95) 100%);
      padding: 35px; /* More padding */
      border-radius: 20px;
      color: #ffffff;
      font-family: var(--text-font);
      border: 3px solid var(--blood-red);
      box-shadow: 0 0 40px rgba(255, 0, 0, 0.25);
      min-width: 500px; /* Even wider */
    }

    .round-scoring-guide .guide-header {
      font-family: var(--title-font);
      font-size: 32px; /* Much bigger header */
      color: var(--blood-red);
      margin-bottom: 25px;
      letter-spacing: 3px;
      text-align: center;
      text-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
      font-weight: bold;
    }

    .round-scoring-guide .guide-items {
      display: flex;
      flex-direction: column;
      gap: 20px; /* More spacing between items */
    }

    .round-scoring-guide .guide-item {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 26px; /* Much bigger text */
      letter-spacing: 1.5px;
      font-weight: 500; /* Slightly bolder */
    }

    .round-scoring-guide .guide-icon {
      font-size: 32px; /* Much bigger icons */
      min-width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 0, 0, 0.15);
      border-radius: 50%;
      text-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
    }

    .round-scoring-guide .guide-text {
      color: rgba(255, 255, 255, 0.95); /* Slightly more opaque */
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      font-weight: 500; /* Slightly bolder */
    }

    .help-menu {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: linear-gradient(135deg, var(--matrix-dark) 0%, rgba(13, 2, 8, 0.95) 100%);
      border: 2px solid var(--blood-red);
      border-radius: 15px;
      color: #ffffff;
      padding: 25px;
      display: none;
      z-index: 1000;
      min-width: 400px;
      box-shadow: 0 0 30px rgba(255, 0, 0, 0.2);
    }

    .help-menu.visible {
      display: block;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateY(-50%) translateX(50px); opacity: 0; }
      to { transform: translateY(-50%) translateX(0); opacity: 1; }
    }

    .help-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--blood-red);
    }

    .help-title {
      font-family: var(--title-font);
      font-size: 28px;
      color: var(--blood-red);
      letter-spacing: 2px;
    }

    .help-key {
      background: rgba(255, 0, 0, 0.2);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 16px;
      color: var(--blood-red);
    }

    .help-section {
      margin-bottom: 25px;
    }

    .help-section h3 {
      font-size: 20px;
      color: var(--blood-red);
      margin-bottom: 15px;
      letter-spacing: 1px;
    }

    .guide-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .guide-item {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 18px;
    }

    .guide-icon {
      font-size: 24px;
      min-width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 0, 0, 0.1);
      border-radius: 50%;
    }

    .control-item {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }

    .control-item .key {
      background: rgba(255, 255, 255, 0.1);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 16px;
      min-width: 60px;
      text-align: center;
    }

    .control-item .action {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
    }

    /* Subtle HUD Hotkey Hints */
    .hotkey-hints {
      position: fixed;
      right: 250px;   /* Moved even more to the left (from 150px) */
      bottom: 40px;
      display: flex;
      gap: 20px;
      font-family: var(--display-font);
      font-size: 18px;
      opacity: 0.7;
      transition: opacity 0.3s;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px 15px;
      border-radius: 8px;
      z-index: 999;
    }

    .hotkey-hints:hover {
      opacity: 1;
    }

    .hotkey-hint {
      color: var(--matrix-green);
      text-shadow: 0 0 8px var(--terminal-green);
      letter-spacing: 0.5px;
    }

    /* Countdown Hotkey Reminder */
    .hotkey-reminder {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 40px; /* Increased gap for bigger text */
      font-family: var(--display-font);
      opacity: 0;
      animation: fadeInGuide 0.5s ease-out 1.5s forwards;
    }

    .hotkey-item {
      color: var(--matrix-green);
      text-shadow: 0 0 12px var(--terminal-green); /* Increased glow for bigger text */
      font-size: 32px; /* Much bigger text */
      letter-spacing: 2px; /* Increased letter spacing */
      font-weight: 500; /* Slightly bolder */
    }

    /* Updated Help Menu Styles */
    .help-menu {
      font-family: var(--display-font);
    }

    .help-title {
      font-family: var(--title-font);
      font-size: 32px;
      color: var(--blood-red);
      letter-spacing: 3px;
      text-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
    }

    .help-key {
      font-family: var(--display-font);
      font-size: 20px;
      padding: 8px 15px;
      border: 1px solid var(--blood-red);
      text-shadow: 0 0 8px var(--glow-red);
    }

    .help-section h3 {
      font-family: var(--title-font);
      font-size: 24px;
      color: var(--blood-red);
      margin-bottom: 20px;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
    }

    .guide-item {
      font-family: var(--display-font);
      font-size: 22px;
      letter-spacing: 1.5px;
    }

    .guide-text {
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
    }

    .control-item {
      font-family: var(--display-font);
      font-size: 20px;
      letter-spacing: 1px;
    }

    .control-item .key {
      font-family: var(--display-font);
      font-size: 18px;
      border: 1px solid rgba(255, 0, 0, 0.3);
      text-shadow: 0 0 5px var(--glow-red);
    }

    .control-item .action {
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }

    @keyframes fadeInGuide {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* Add combo notification styles directly here */
    .combo-notification {
      position: fixed;
      left: 50%;
      bottom: 80px;  /* Moved lower, closer to the bottom */
      transform: translateX(-50%);
      pointer-events: none;
      font-family: var(--display-font);
      text-align: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .combo-notification.active {
      opacity: 1;
    }

    .combo-counter {
      background: rgba(0, 0, 0, 0.3);
      padding: 4px 12px;
      border-radius: 4px;
      backdrop-filter: blur(2px);
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .combo-hits {
      font-size: 24px;
      font-weight: bold;
      color: var(--matrix-green);
      text-shadow: 0 0 6px var(--terminal-green);
      opacity: 0.9;
    }

    .combo-text {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.8);
      text-shadow: 0 0 4px rgba(255, 255, 255, 0.4);
      letter-spacing: 1px;
    }

    .combo-bonus {
      font-size: 16px;
      color: rgba(255, 255, 0, 0.8);
      text-shadow: 0 0 4px rgba(255, 255, 0, 0.4);
      letter-spacing: 1px;
      margin-left: 4px;
    }

    @keyframes comboSlideIn {
      from {
        transform: translateX(-50%) translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    /* Combo tiers with different colors */
    .combo .combo-hits { 
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 0 0 4px rgba(255, 255, 255, 0.4);
    }
    .super-combo .combo-hits { 
      color: rgba(0, 255, 255, 0.9);
      text-shadow: 0 0 4px rgba(0, 255, 255, 0.4);
    }
    .ultra-combo .combo-hits { 
      color: rgba(255, 0, 255, 0.9);
      text-shadow: 0 0 4px rgba(255, 0, 255, 0.4);
    }
    .mega-combo .combo-hits { 
      color: rgba(255, 0, 0, 0.9);
      text-shadow: 0 0 4px rgba(255, 0, 0, 0.4);
    }

    .countdown {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: var(--title-font);
      font-size: 72px;
      color: var(--blood-red);
      text-shadow: 0 0 20px var(--glow-red);
      z-index: 1000;
      animation: countdownPulse 1s ease-in-out;
    }

    @keyframes countdownPulse {
      0% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
    }

    .system-message {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: var(--display-font);
      font-size: 24px;
      color: var(--blood-red);
      text-shadow: 0 0 10px var(--glow-red);
      background: rgba(13, 2, 8, 0.9);
      padding: 15px 30px;
      border-radius: 8px;
      border: 1px solid var(--blood-red);
      z-index: 1000;
      animation: fadeInOut 4s ease-in-out;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -60%); }
      10% { opacity: 1; transform: translate(-50%, -50%); }
      90% { opacity: 1; transform: translate(-50%, -50%); }
      100% { opacity: 0; transform: translate(-50%, -40%); }
    }

    .round-end {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, var(--matrix-dark) 0%, rgba(13, 2, 8, 0.95) 100%);
      padding: 30px;
      border-radius: 16px;
      color: #ffffff;
      font-family: var(--text-font);
      backdrop-filter: blur(10px);
      border: 2px solid var(--blood-red);
      box-shadow: 0 0 40px rgba(255, 0, 0, 0.3),
                  inset 0 0 20px rgba(255, 0, 0, 0.2);
      z-index: 1000;
      min-width: 400px;
      text-align: center;
    }

    .round-end-title {
      font-family: var(--title-font);
      font-size: 24px;
      color: var(--blood-red);
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 0 0 15px var(--glow-red);
    }

    .round-end-placement {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      padding: 10px 20px;
      background: linear-gradient(90deg, rgba(139, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0) 100%);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .round-end-placement.first {
      background: linear-gradient(90deg, rgba(255, 215, 0, 0.2) 0%, rgba(0, 0, 0, 0) 100%);
      border: 1px solid #ffd700;
    }

    .placement-rank {
      font-family: var(--number-font);
      font-size: 28px;
      color: var(--matrix-green);
      min-width: 40px;
    }

    .placement-points {
      font-family: var(--number-font);
      font-size: 24px;
      color: var(--terminal-green);
    }

    .next-round-timer {
      font-family: var(--display-font);
      font-size: 18px;
      color: #ffffff;
      margin-top: 20px;
      opacity: 0.8;
    }

    .round-complete-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);  /* Changed to center both vertically and horizontally */
      font-family: var(--display-font);
      font-size: 48px;  /* Made even larger */
      color: var(--matrix-green);
      text-shadow: 0 0 20px var(--terminal-green);  /* Increased glow */
      background: rgba(13, 2, 8, 0.9);
      padding: 20px 40px;  /* Increased padding */
      border-radius: 8px;
      border: 2px solid var(--matrix-green);  /* Made border thicker */
      z-index: 1000;  /* Increased z-index to ensure it's on top */
      text-align: center;
      animation: pulseCenter 0.5s ease-out infinite;
    }

    @keyframes pulseCenter {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.1); }  /* Increased scale effect */
      100% { transform: translate(-50%, -50%) scale(1); }
    }
  </style>
</head>
<body>
<!-- Scene UI Templates -->
<template id="hit-notification-template">
  <div class="hit-notification">
    <span class="score">+0</span>
  </div>
</template>

<template id="block-destroyed-notification-template">
  <div class="block-destroyed-notification">
    <div class="score">+0</div>
  </div>
</template>

<template id="combo-notification-template">
  <div class="combo-notification">
    <div class="combo-counter">
      <div class="combo-hits"></div>
      <div class="combo-text"></div>
      <div class="combo-bonus"></div>
    </div>
  </div>
</template>

<script>
  // Register Scene UI Templates
  hytopia.registerSceneUITemplate('hit-notification', (id, onState) => {
    const template = document.getElementById('hit-notification-template');
    const clone = template.content.cloneNode(true);
    const scoreElement = clone.querySelector('.score');
    
    onState(state => {
      if (scoreElement && state?.score != null) {
        scoreElement.textContent = `+${Math.round(Number(state.score))}`;
      }
    });
    
    return clone;
  });

  hytopia.registerSceneUITemplate('block-destroyed-notification', (id, onState) => {
    const template = document.getElementById('block-destroyed-notification-template');
    const clone = template.content.cloneNode(true);
    
    // Get both elements - we need to get these before returning the clone
    const scoreElement = clone.querySelector('.score');
    
    // Register the state handler
    onState(state => {
      if (scoreElement && state?.score != null) {
        const score = Math.round(Number(state.score));
        scoreElement.textContent = `+${score}`;
        
        // Apply score class
        if (state.class) {
          scoreElement.className = `score ${state.class}`;
        }
        
        // Apply custom style if provided
        if (state.style) {
          scoreElement.style.cssText = state.style;
        }
      }
    });
    
    return clone;
  });

  // Update the combo notification template registration
  hytopia.registerSceneUITemplate('combo-notification', (id, onState) => {
    const template = document.getElementById('combo-notification-template');
    if (!template) {
      console.error('Could not find combo-notification-template');
      return document.createElement('div');
    }
    
    const clone = template.content.cloneNode(true);
    
    // Get all the elements we need to update
    const container = clone.querySelector('.combo-notification');
    const hitsElement = clone.querySelector('.combo-hits');
    const textElement = clone.querySelector('.combo-text');
    const bonusElement = clone.querySelector('.combo-bonus');
    
    onState(state => {
      if (state && container) {
        // Update the combo class based on hits
        const comboClass = state.hits >= 10 ? 'mega-combo' :
                          state.hits >= 7 ? 'ultra-combo' :
                          state.hits >= 5 ? 'super-combo' :
                          'combo';
        container.className = `combo-notification ${comboClass} active`;
        
        // Update the text content
        if (hitsElement) hitsElement.textContent = `${state.hits}x`;
        if (textElement) textElement.textContent = state.text;
        if (bonusElement) bonusElement.textContent = `+${state.bonus}%`;

        // Clear any existing timeout
        if (comboTimeout) {
          clearTimeout(comboTimeout);
        }

        // Set new timeout to remove active class
        comboTimeout = setTimeout(() => {
          container.classList.remove('active');
        }, 2000);
      }
    });
    
    return clone;
  });
</script>

<div class="countdown-overlay">
  <div class="countdown-display"></div>
  <div class="round-scoring-guide">
    <div class="guide-header">HOW TO SCORE</div>
    <div class="guide-items">
      <div class="guide-item">
        <span class="guide-icon">üéØ</span>
        <span class="guide-text">DISTANCE = MORE POINTS</span>
      </div>
      <div class="guide-item">
        <span class="guide-icon">‚ö°</span>
        <span class="guide-text">FASTER BLOCKS = BIGGER SCORE</span>
      </div>
      <div class="guide-item">
        <span class="guide-icon">‚è±Ô∏è</span>
        <span class="guide-text">QUICK SHOTS COUNT</span>
      </div>
      <div class="guide-item">
        <span class="guide-icon">üî•</span>
        <span class="guide-text">CHAIN HITS FOR COMBOS</span>
      </div>
    </div>
  </div>
  <div class="hotkey-reminder">
    <div class="hotkey-item">[H] Game Guide</div>
    <div class="hotkey-item">[P] Settings</div>
    <div class="hotkey-item">[ESC] Show Cursor</div>
  </div>
</div>

<div class="scoreboard">
  <div class="round-info">
    <div id="waitingMessage" class="waiting-message" style="display: none;"></div>
    <div class="player-count" style="display: none">Players: 0/2</div>
    <div class="round-number"></div>
    <div class="round-timer"></div>
  </div>
  <div class="scores-wrapper">
    <div id="scores-container">
      <!-- Scores will be added here dynamically -->
    </div>
  </div>
</div>

<div class="leaderboard">
  <div class="leaderboard-title">Leaderboard</div>
  <div id="leaderboard-container">
    <!-- Leaderboard entries will be added here dynamically -->
  </div>
</div>

<div class="projectile-counter">
  <div class="particles"></div>
  <div class="projectile-icon"></div>
  <div class="projectile-count">5</div>
</div>

<div class="crosshair"></div>

<!-- Add the combo notification element here -->
<div class="combo-notification">
  <div class="combo-counter">
    <div class="combo-hits"></div>
    <div class="combo-text"></div>
    <div class="combo-bonus"></div>
  </div>
</div>

<div class="settings-overlay"></div>
<div class="settings-menu">
  <div class="settings-title">Settings</div>
  
  <!-- Game Settings Section -->
  <div class="settings-section">
    <div class="settings-section-title">Game Settings</div>
    <div class="settings-option">
      <span class="settings-label">Mouse Sensitivity</span>
      <div class="settings-value">
        <input type="range" min="1" max="100" value="50" id="sensitivity-slider">
        <span id="sensitivity-value">50</span>
      </div>
    </div>
    <div class="settings-option">
      <span class="settings-label">Background Music Volume</span>
      <div class="settings-value">
        <input type="range" min="0" max="100" value="10" id="bgm-volume-slider">
        <span id="bgm-volume-value">10</span>
      </div>
    </div>
  </div>

  <!-- Crosshair Settings Section -->
  <div class="settings-section">
    <div class="settings-section-title">Crosshair Settings</div>
    <div class="settings-option">
      <span class="settings-label">Crosshair Color</span>
      <div class="settings-value color-controls">
        <select id="color-preset" class="color-dropdown">
          <option value="">Custom</option>
          <option value="#ffff00">Yellow</option>
          <option value="#00ff7f">Green</option>
          <option value="#ff4d4d">Red</option>
          <option value="#66ffff">Cyan</option>
          <option value="#ff66ff">Magenta</option>
          <option value="#ffffff">White</option>
          <option value="#ffb366">Orange</option>
          <option value="#66ffb3">Mint</option>
          <option value="#b366ff">Purple</option>
          <option value="#ff66b3">Pink</option>
        </select>
        <input type="color" value="#ffff00" id="crosshair-color">
      </div>
    </div>

    <div class="settings-option">
      <span class="settings-label">Crosshair Elements</span>
      <div class="settings-value">
        <label class="checkbox-label">
          <input type="checkbox" id="show-ring" checked>
          Ring
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="show-dot" checked>
          Dot
        </label>
      </div>
    </div>

    <div class="settings-option">
      <span class="settings-label">Global Size</span>
      <div class="settings-value">
        <input type="range" min="12" max="48" value="24" id="global-size-slider">
        <span id="global-size-value">24px</span>
      </div>
    </div>

    <div class="settings-option">
      <span class="settings-label">Ring Size</span>
      <div class="settings-value">
        <input type="range" min="8" max="40" value="20" id="ring-size-slider">
        <span id="ring-size-value">20px</span>
      </div>
    </div>

    <div class="settings-option">
      <span class="settings-label">Dot Size</span>
      <div class="settings-value">
        <input type="range" min="2" max="12" value="4" id="dot-size-slider">
        <span id="dot-size-value">4px</span>
      </div>
    </div>
  </div>

  <!-- Resume Button -->
  <div class="settings-option">
    <button class="settings-button" id="resume-button">Resume Game</button>
  </div>
</div>

<div class="help-menu">
    <div class="help-header">
        <span class="help-title">GAME GUIDE</span>
        <span class="help-key">[H]</span>
    </div>
    <div class="help-content">
        <div class="help-section scoring">
            <h3>üéØ SCORING SYSTEM</h3>
            <div class="guide-items">
                <div class="guide-item">
                    <span class="guide-icon">üéØ</span>
                    <span class="guide-text">DISTANCE = MORE POINTS</span>
                </div>
                <div class="guide-item">
                    <span class="guide-icon">‚ö°</span>
                    <span class="guide-text">FASTER BLOCKS = BIGGER SCORE</span>
                </div>
                <div class="guide-item">
                    <span class="guide-icon">‚è±Ô∏è</span>
                    <span class="guide-text">QUICK SHOTS COUNT</span>
                </div>
                <div class="guide-item">
                    <span class="guide-icon">üî•</span>
                    <span class="guide-text">CHAIN HITS FOR COMBOS</span>
                </div>
            </div>
        </div>
        <div class="help-section controls">
            <h3>üéÆ CONTROLS</h3>
            <div class="control-item">
                <span class="key">[ESC]</span>
                <span class="action">Show Cursor</span>
            </div>
            <div class="control-item">
                <span class="key">[P]</span>
                <span class="action">Settings Menu</span>
            </div>
            <div class="control-item">
                <span class="key">[H]</span>
                <span class="action">Help Guide</span>
            </div>
        </div>
    </div>
</div>

<div class="hotkey-hints">
    <div class="hotkey-hint">[H] Game Guide</div>
    <div class="hotkey-hint">[P] Settings</div>
    <div class="hotkey-hint">[ESC] Show Cursor</div>
</div>

<script>
let projectileCount = 5;
let particles = [];

const scoresContainer = document.getElementById('scores-container');

// Create particle effect
function createParticle() {
  const particles = document.querySelector('.particles');
  const particle = document.createElement('div');
  particle.className = 'particle';
  
  // Random position
  const x = Math.random() * 100;
  const y = Math.random() * 100;
  
  particle.style.left = x + '%';
  particle.style.top = y + '%';
  
  // Random animation
  const animation = particle.animate([
    { transform: 'translate(0, 0)', opacity: 1 },
    { transform: `translate(${Math.random() * 50 - 25}px, ${Math.random() * 50 - 25}px)`, opacity: 0 }
  ], {
    duration: 1000 + Math.random() * 1000,
    easing: 'cubic-bezier(0,0,0.2,1)'
  });
  
  particles.appendChild(particle);
  animation.onfinish = () => particle.remove();
}

// Create particles periodically
setInterval(createParticle, 200);

// Listen for projectile count updates and shoot attempts from the game
hytopia.onData(data => {
  if (data.type === 'updateProjectileCount') {
    updateProjectileCount(data.count);
  } else if (data.type === 'attemptShootNoAmmo') {
    triggerShakeAnimation();
  } else if (data.type === 'updateScores') {
    updateScoreboard(data.scores);
  } else if (data.type === 'roundUpdate') {
    updateRoundInfo(data.data);
  } else if (data.type === 'roundEnd') {
    handleRoundEnd(data.data);
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  } else if (data.type === 'waitingForPlayers') {
    showWaitingForPlayers(data.data);
  } else if (data.type === 'countdown') {
    showCountdown(data.count);
  } else if (data.type === 'updateLeaderboard') {
    updateLeaderboard(data.leaderboard);
  } else if (data.type === 'showCombo') {
    showComboNotification(data.data);
  } else if (data.type === 'resetCombo') {
    const container = document.querySelector('.combo-notification');
    container.classList.remove('active');
    if (window.comboTimeout) {
      clearTimeout(window.comboTimeout);
    }
  }
});

function triggerShakeAnimation() {
  const counterElement = document.querySelector('.projectile-counter');
  counterElement.classList.remove('shake');
  void counterElement.offsetWidth; // Trigger reflow
  counterElement.classList.add('shake');
  
  // Remove the class after animation completes
  setTimeout(() => {
    counterElement.classList.remove('shake');
  }, 820); // Match the animation duration
}

function updateProjectileCount(count) {
  const countElement = document.querySelector('.projectile-count');
  const counterElement = document.querySelector('.projectile-counter');
  const iconElement = document.querySelector('.projectile-icon');
  
  // Add pulse animation
  countElement.classList.remove('count-change');
  void countElement.offsetWidth; // Trigger reflow
  countElement.classList.add('count-change');
  
  // Update count with transition
  countElement.textContent = count;
  
  // Visual feedback for low ammo
  if (count <= 2) {
    counterElement.classList.add('low');
    iconElement.style.background = 'radial-gradient(circle at 30% 30%, #ff6b6b, #ff0000)';
    iconElement.style.boxShadow = '0 0 15px #ff0000';
  } else {
    counterElement.classList.remove('low');
    iconElement.style.background = 'radial-gradient(circle at 30% 30%, #6ae675, #4CAF50)';
    iconElement.style.boxShadow = '0 0 15px #4CAF50';
  }
  
  projectileCount = count;
}

function showWaitingForPlayers(data) {
  const waitingMessage = document.querySelector('.waiting-message');
  const playerCount = document.querySelector('.player-count');
  const gameElements = document.querySelectorAll('.round-number, .round-timer');
  
  // Show waiting elements
  waitingMessage.style.display = 'block';
  playerCount.style.display = 'block';
  playerCount.textContent = `Players: ${data.current}/${data.required}`;
  
  // Hide game elements
  gameElements.forEach(el => el.style.display = 'none');
}

let lastTimeRemaining = 0;
let timerInterval = null;
let timerEndTime = 0;

function startLocalTimer(initialTimeMs) {
  // Clear any existing timer
  if (timerInterval) {
    clearInterval(timerInterval);
  }
  
  // Set the end time based on current time plus duration
  timerEndTime = Date.now() + initialTimeMs;
  lastTimeRemaining = initialTimeMs;
  
  function updateTimer() {
    const now = Date.now();
    const remaining = Math.max(0, timerEndTime - now);
    
    // Update lastTimeRemaining for potential server sync
    lastTimeRemaining = remaining;
    
    const timeRemaining = Math.ceil(remaining / 1000);
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    const formattedTime = `Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    const roundTimer = document.querySelector('.round-timer');
    if (roundTimer) {
      roundTimer.textContent = formattedTime;
      
      // Update visual feedback
      roundTimer.classList.remove('warning', 'danger');
      if (timeRemaining <= 10) {
        roundTimer.classList.add('danger');
      } else if (timeRemaining <= 30) {
        roundTimer.classList.add('warning');
      }
    }
    
    // Only clear interval if we've actually reached zero
    if (remaining <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      
      // Send a message to the game that time is up
      if (typeof hytopia !== 'undefined') {
        hytopia.sendData({ type: 'timeUp' });
      }
    }
  }
  
  // Initial update
  updateTimer();
  
  // Start interval for updates
  timerInterval = setInterval(updateTimer, 100); // Update more frequently for smoother countdown
}

function updateRoundInfo(roundData) {
  const waitingMessage = document.querySelector('.waiting-message');
  const playerCount = document.querySelector('.player-count');
  const gameElements = document.querySelectorAll('.round-number, .round-timer');
  
  // Hide waiting elements
  waitingMessage.style.display = 'none';
  playerCount.style.display = 'none';
  
  // Show game elements
  gameElements.forEach(el => el.style.display = 'block');
  
  // Update round info
  const roundNumber = document.querySelector('.round-number');
  roundNumber.textContent = `Round ${roundData.round}`;
  
  // Clear any active combo notification
  const comboNotification = document.querySelector('.combo-notification');
  if (comboNotification) {
    comboNotification.classList.remove('active');
    if (window.comboTimeout) {
      clearTimeout(window.comboTimeout);
    }
  }

  // Reset both total and round scores in the scoreboard
  const scores = document.querySelectorAll('.player-score');
  scores.forEach(score => {
    const totalScore = score.querySelector('.score-value');
    const roundScore = score.querySelector('.round-score');
    if (totalScore) {
      totalScore.textContent = '0';
    }
    if (roundScore) {
      roundScore.textContent = '(+0)';
    }
  });
  
  // Start or update timer with the full duration
  if (roundData.timeRemaining > 0) {
    startLocalTimer(roundData.timeRemaining);
  }
}

function handleRoundEnd(data) {
  // Create round complete message with new styling
  const statusMessage = document.createElement('div');
  statusMessage.className = 'round-complete-message';
  statusMessage.textContent = 'Round Complete!';
  
  // Add to body instead of roundInfo
  document.body.appendChild(statusMessage);

  // Reset scores for next round
  const scores = document.querySelectorAll('.player-score');
  scores.forEach(score => {
    const totalScore = score.querySelector('.score-value');
    const roundScore = score.querySelector('.round-score');
    if (totalScore) {
      totalScore.textContent = '0';
    }
    if (roundScore) {
      roundScore.textContent = '(+0)';
    }
  });
  
  // Remove status message after transition to next round
  setTimeout(() => {
    statusMessage.remove();
  }, data.nextRoundIn);
}

function updateScoreboard(scores) {
  scoresContainer.innerHTML = '';
  scores.forEach((score, index) => {
    const playerDiv = document.createElement('div');
    playerDiv.className = 'player-score';
    
    // Ensure we're using numbers and not accidentally concatenating strings
    const totalPoints = Number(score.totalPoints || 0);
    const roundScore = Number(score.roundScore || 0);
    
    playerDiv.innerHTML = `
      <span class="player-label">P${index + 1}</span>
      <span class="score-value">${totalPoints}</span>
      <span class="round-score">(+${roundScore})</span>
    `;
    scoresContainer.appendChild(playerDiv);
  });
}

function showCountdown(count) {
  const overlay = document.querySelector('.countdown-overlay');
  const display = document.querySelector('.countdown-display');
  
  // Show overlay
  overlay.classList.add('visible');
  
  // Update display
  if (count === 'GO!') {
    display.className = 'countdown-display countdown-go';
  } else {
    display.className = 'countdown-display countdown-number';
  }
  display.textContent = count;
  
  // Remove overlay after GO!
  if (count === 'GO!') {
    setTimeout(() => {
      overlay.classList.remove('visible');
    }, 1000);
  }
}

function updateLeaderboard(leaderboardData) {
  const container = document.getElementById('leaderboard-container');
  container.innerHTML = '';
  
  leaderboardData.forEach((entry, index) => {
    const entryDiv = document.createElement('div');
    entryDiv.className = `leaderboard-entry ${entry.isLeading ? 'winner' : ''}`;
    
    // Update the display to show placement points
    entryDiv.innerHTML = `
      <div class="player-name">
        <span class="player-rank">#${index + 1}</span>
        <span>P${entry.playerNumber}</span>
      </div>
      <span class="player-wins">${entry.points} points</span>
    `;
    
    container.appendChild(entryDiv);
  });
}

// Settings menu functionality
let isSettingsOpen = false;

function toggleSettings(show) {
  const menu = document.querySelector('.settings-menu');
  const overlay = document.querySelector('.settings-overlay');
  isSettingsOpen = show;
  
  if (show) {
    menu.classList.add('visible');
    overlay.classList.add('visible');
    
    // Request current settings when opening menu
    hytopia.sendData({ 
      type: 'requestSettings'
    });
  } else {
    menu.classList.remove('visible');
    overlay.classList.remove('visible');
  }
}

// Listen for Escape key - work with cursor state
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    // If settings are open, close them
    if (isSettingsOpen) {
      toggleSettings(false);
      e.preventDefault(); // Prevent the default escape behavior
    } else {
      // If cursor becomes visible (handled by game), show settings
      setTimeout(() => {
        const cursorStyle = window.getComputedStyle(document.body).cursor;
        if (cursorStyle === 'default' || cursorStyle === 'auto') {
          toggleSettings(true);
        }
      }, 50); // Small delay to ensure cursor state has updated
    }
  }
});

// Multiple hotkeys for settings
document.addEventListener('keydown', (e) => {
  if (e.key === 'Tab' || e.key.toLowerCase() === 'p') { // Added 'P' key
    e.preventDefault(); // Prevent default behavior
    const cursorStyle = window.getComputedStyle(document.body).cursor;
    if (cursorStyle === 'default' || cursorStyle === 'auto') {
      toggleSettings(!isSettingsOpen);
    }
  }
});

// Resume button - close settings and hide cursor
document.getElementById('resume-button').addEventListener('click', () => {
  toggleSettings(false);
  hytopia.sendData({ type: 'hideCursor' }); // Tell game to hide cursor again
});

// Handle settings changes
document.getElementById('sensitivity-slider').addEventListener('input', (e) => {
  const value = e.target.value;
  document.getElementById('sensitivity-value').textContent = value;
  hytopia.sendData({ 
    type: 'updateSettings',
    setting: 'sensitivity',
    value: Number(value)
  });
});

// Background music volume handler with debounce
let volumeTimeout;
const volumeSlider = document.getElementById('bgm-volume-slider');
const volumeValue = document.getElementById('bgm-volume-value');

// Initialize volume UI with default value
volumeSlider.value = '10'; // Default value (10%)
volumeValue.textContent = '10';

volumeSlider.addEventListener('input', (e) => {
  const value = e.target.value;
  volumeValue.textContent = value;
  
  // Clear any pending timeout
  if (volumeTimeout) {
    clearTimeout(volumeTimeout);
  }
  
  // Set a new timeout to update the volume
  volumeTimeout = setTimeout(() => {
    // Ensure we send exactly 0 when slider is at minimum
    const volumeValue = Number(value);
    hytopia.sendData({ 
      type: 'updateSettings',
      setting: 'bgmVolume',
      value: volumeValue === 0 ? 0 : volumeValue
    });
  }, 50); // Small delay to prevent too many updates
});

// Listen for settings updates from the game
hytopia.onData(data => {
  if (data.type === 'settingsUpdate' && data.settings) {
    // Update volume slider
    if (data.settings.bgmVolume !== undefined) {
      const uiValue = Math.round(data.settings.bgmVolume * 100);
      volumeSlider.value = String(uiValue);
      volumeValue.textContent = String(uiValue);
    }
  }
});

// Function to update crosshair color
function updateCrosshairColor(color) {
  const root = document.documentElement;
  const colorPicker = document.getElementById('crosshair-color');
  
  // Update color picker value
  colorPicker.value = color;
  
  // Convert hex to rgba for main color
  const r = parseInt(color.slice(1,3), 16);
  const g = parseInt(color.slice(3,5), 16);
  const b = parseInt(color.slice(5,7), 16);
  
  // Set the CSS variables
  root.style.setProperty('--crosshair-color', `rgba(${r}, ${g}, ${b}, 0.8)`);
  root.style.setProperty('--crosshair-glow', color);
  
  // Send to game
  hytopia.sendData({ 
    type: 'updateSettings',
    setting: 'crosshairColor',
    value: color
  });
}

// Color picker handler
document.getElementById('crosshair-color').addEventListener('input', (e) => {
  updateCrosshairColor(e.target.value);
  // Reset dropdown to "Custom" when using color picker
  document.getElementById('color-preset').value = '';
});

// Dropdown handler
document.getElementById('color-preset').addEventListener('change', (e) => {
  if (e.target.value) {
    updateCrosshairColor(e.target.value);
  }
});

// Function to update crosshair sizes
function updateCrosshairSizes() {
  const root = document.documentElement;
  const globalSize = document.getElementById('global-size-slider').value;
  const ringSize = document.getElementById('ring-size-slider').value;
  const dotSize = document.getElementById('dot-size-slider').value;
  
  root.style.setProperty('--crosshair-size', `${globalSize}px`);
  root.style.setProperty('--ring-size', `${ringSize}px`);
  root.style.setProperty('--dot-size', `${dotSize}px`);
  
  // Update display values
  document.getElementById('global-size-value').textContent = `${globalSize}px`;
  document.getElementById('ring-size-value').textContent = `${ringSize}px`;
  document.getElementById('dot-size-value').textContent = `${dotSize}px`;
  
  // Send to game
  hytopia.sendData({
    type: 'updateSettings',
    setting: 'crosshairSizes',
    value: { globalSize, ringSize, dotSize }
  });
}

// Function to update crosshair visibility
function updateCrosshairVisibility() {
  const root = document.documentElement;
  const showRing = document.getElementById('show-ring').checked;
  const showDot = document.getElementById('show-dot').checked;
  
  root.style.setProperty('--show-ring', showRing ? 'block' : 'none');
  root.style.setProperty('--show-dot', showDot ? 'block' : 'none');
  
  // Send to game
  hytopia.sendData({
    type: 'updateSettings',
    setting: 'crosshairVisibility',
    value: { showRing, showDot }
  });
}

// Size slider handlers
document.getElementById('global-size-slider').addEventListener('input', updateCrosshairSizes);
document.getElementById('ring-size-slider').addEventListener('input', updateCrosshairSizes);
document.getElementById('dot-size-slider').addEventListener('input', updateCrosshairSizes);

// Visibility checkbox handlers
document.getElementById('show-ring').addEventListener('change', updateCrosshairVisibility);
document.getElementById('show-dot').addEventListener('change', updateCrosshairVisibility);

// Add this to your existing script section
let isHelpOpen = false;

document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'h') {
        e.preventDefault();
        toggleHelp(!isHelpOpen);
    }
});

function toggleHelp(show) {
    const menu = document.querySelector('.help-menu');
    isHelpOpen = show;
    
    if (show) {
        menu.classList.add('visible');
    } else {
        menu.classList.remove('visible');
    }
}



// Add this to your existing script
function updateHotkeysVisibility(show) {
    const hints = document.querySelector('.hotkey-hints');
    if (hints) {
        hints.style.display = show ? 'flex' : 'none';
    }
}

// Hide hotkeys when menus are open
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' || e.key.toLowerCase() === 'p' || e.key.toLowerCase() === 'h') {
        updateHotkeysVisibility(false);
    }
});

// Show hotkeys when menus are closed
function onMenuClose() {
    updateHotkeysVisibility(true);
}

// Add this to your existing script
let comboTimeout = null;

function showComboNotification(data) {
  const container = document.querySelector('.combo-notification');
  const hitsElement = container.querySelector('.combo-hits');
  const textElement = container.querySelector('.combo-text');
  const bonusElement = container.querySelector('.combo-bonus');
  
  // Update the combo class based on hits
  const comboClass = data.hits >= 10 ? 'mega-combo' :
                    data.hits >= 7 ? 'ultra-combo' :
                    data.hits >= 5 ? 'super-combo' :
                    'combo';
  
  container.className = `combo-notification ${comboClass} active`;
  
  // Update the text content
  hitsElement.textContent = `${data.hits}x`;
  textElement.textContent = data.text;
  bonusElement.textContent = `+${data.bonus}%`;
  
  // Clear any existing timeout
  if (comboTimeout) {
    clearTimeout(comboTimeout);
  }
  
  // Hide after 2 seconds
  comboTimeout = setTimeout(() => {
    container.classList.remove('active');
  }, 2000);
}

// Add help toggle to settings menu
document.querySelector('.settings-menu').addEventListener('click', () => {
    toggleHelp(false); // Close help when opening settings
});

// Add this instead
document.addEventListener('DOMContentLoaded', () => {
    const settingsMenu = document.querySelector('.settings-menu');
    if (settingsMenu) {
        settingsMenu.addEventListener('click', () => {
            toggleHelp(false); // Close help when opening settings
        });
    }
});
</script>

</body>
</html>

